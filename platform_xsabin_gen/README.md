
Create a Harware plaform project from the original shell XSA file. The XSA file
is likely be found at `/opt/xilinx/platforms/xilinx_vck5000_gen4x8_qdma_2_202220_1/hw/xilinx_vck5000_gen4x8_qdma_2_202220_1.xsa`

```
cp /opt/xilinx/platforms/xilinx_vck5000_gen4x8_qdma_2_202220_1/hw/xilinx_vck5000_gen4x8_qdma_2_202220_1.xsa .
vivado -mode tcl
open_hw_platform  xilinx_vck5000_gen4x8_qdma_2_202220_1.xsa
```

It will create the folder `xilinx_vck5000_gen4x8_qdma_2_202220_1/`

Replace the original shell dcp with the new shell dcp

```
cp ../ulp_design/utils/xilinx_vck5000_gen4x8_qdma_2_202220_1_bb_locked.dcp ./xilinx_vck5000_gen4x8_qdma_2_202220_1/hw_platform
```
                                                                               
Get the Platform UUID

```
xbutil examine -d <user BDF>
```

The output should be similar to 

image


Next, modify the pre OPT tcl hook script `./prj.srcs/utils_1/imports/tcl_hooks/opt.pre.tcl`
so that Vivado will set the UUID of the rom cell before `opt_design`.
This UUID must match the Platform UUID as shown in the following example.


```
source ../hw_platform/iprepo/iprepo/shell_utils_uuid_rom_v2_0/tcl/update_uuid_rom.tcl
update_uuid_rom 05dca09676cb730b8d19ec1192fbae3f [get_cells top_i/blp/blp_logic/uuid_rom/U0/xpm_memory_spram_inst/xpm_memory_base_inst]
```

XRT drivers (xbmgmt/xocl) check the ROM UUID during firmware loading at startup.
If it mismatches with the Platform UUID, the drivers will fail to recognize the
device, hence render it unusable.

Then, open the project and run device image generation

```
cd ./xilinx_vck5000_gen4x8_qdma_2_202220_1/prj
vivado prj.xpr
launch_runs impl_1 -to_step write_device_image
```

Vivado will generate `top_wrapper.rcdo` and `top_wrapper.rnpi` after finishing this command.
These files contain configuration data regarding the PL implementation of the BLP design
with the new shell. We don't need the PDI file obtained from this project, but
rather we are going to replace the PL section of the original PDI with the configuration data
from `top_wrapper.rcdo` and `top_wrapper.rnpi`.
This ensures that only the PL section of the original PDI is modified, whereas
the original sections remain intact.
Using the PDI generated by this hardware platform project is unlikely working
(personal experience). The reason might be that some configuration data from sections
other than PL could be incompatible with the card firmware. Since the vendor project
for generating the base platform PDI is not public available, relying on the
original PDI is a viable option.

We use Xilinx tool `bootgen` to modify the content of a PDI file. However, the
current version of `bootgen` does not support replacing PL sections. Instead, we
use this forked (`bootgen`)[https://github.com/nqdtan/bootgen]

```
# Install bootgen
git clone -b pl_cfi_replace https://github.com/nqdtan/bootgen.git
cd bootgen/
make
```

Get the original partition xsabin (usually located at `/opt/xilinx/firmware/vck5000/gen4x8-qdma/base/partition.xsabin`)
Dump the PDI content of the xsabin file to get `partition.pdi`

```
cp /opt/xilinx/firmware/vck5000/gen4x8-qdma/base/partition.xsabin .
xclbinutil --dump-section PDI:RAW:partition.pdi --input partition.xsabin
```

Create a bootimage.bif file with the following content

```
all:
{
    image
    {
        { type=bootimage, file=partition.pdi }
    }
    image
    {
      name = pl_cfi
      id = 0x18700000
      partition
      {
        id = 0x03
        type = cdo
        file = top_wrapper.rcdo
      }
      partition
      {
        id = 0x05
        type = cdo
        file = top_wrapper.rnpi
      }
    }
}
```

Run bootgen to generate new PDI

```
# Input is bootimage.bif, output is partition_new.pdi
# Make sure partition.pdi, top_wrapper.rcdo, top_wrapper.rnpi are in the same directory
cp ../xilinx_vck5000_gen4x8_qdma_2_202220_1/prj/prj.runs/impl_1/top_wrapper.rcdo .
cp ../xilinx_vck5000_gen4x8_qdma_2_202220_1/prj/prj.runs/impl_1/top_wrapper.rnpi .
./bootgen -arch versal -image ../bootimage.bif -w -o partition_new.pdi

# Read the content of PDI. You can verify that the PL sections are updated
# in partition_new.pdi. Note that there should be only two PL sections, or
# Partition Header Tables (pl_cfi.0 with id 0x03 and pl_cfi.1 with id 0x05)
./bootgen -arch versal -read partition.pdi > log_old
./bootgen -arch versal -read partition_new.pdi > log_new
```

After that, we use `xclbinutil` to generate a new xsabin.  
Program the card with this new xsabin.                                           

```
# Remove old PDI from original xsabin
xclbinutil --remove-section PDI --input partition.xsabin --output partition_tmp.xsabin
# Add new PDI
xclbinutil --add-section PDI:RAW:partition_new.pdi --input partition_tmp.xsabin --output partition_new.xsabin
# Backup the original xsabin
cd /lib/firmware/xilinx/05dca09676cb730b8d19ec1192fbae3f
cp partition.xsabin partition.xsabin.bak
# Override xsabin file with the new one
cp /path/to/spades/platform_xsabin_gen/partition_new.xsabin partition.xsabin
# Reprogram the base shell. The command will look for partition.xsabin in the same folder
xbmgmt program --base shell --device <management BID> --image xilinx_vck5000_gen4x8_qdma_base_2 --verbose --force
```

Cold reboot the machine.

# Troubleshooting

If the host machine failed to recognize the device after the cold reboot, something had gone wrong
with the newly generated xsabin. You can revert the device state to the original status
by using a JTAG cable. Have another machine installed Vivado, then connect to the
card of the host machine via a JTAG cable. Open Vivado Hardware Manager, download
the original xsabin file to the card, then perform a cold reboot on the host machine.

This might happen when we inadvertently updated some sections (partitions) other than
pl in the `partition.pdi` file, or used a wrong `partition.pdi`. If you notice the
your card fan behaves differently (getting louder) after you reprogram
the shell with a new xsabin (or afer a cold reboot), it is likely that some part
in the new xsabin does not conform with the current card firmware. Remember that
our purpose here is to make a minimal update of the PL implementation of the shell
(rerouting several wires); it should not affect other device subsystems.
